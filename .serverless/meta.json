{
  "/Users/benjaminponce/Documents/aws_retos/servicio_rimac/serverless.yml": {
    "versionFramework": "4.31.2",
    "servicePath": "/Users/benjaminponce/Documents/aws_retos/servicio_rimac/serverless.yml",
    "serviceConfigFileName": "serverless.yml",
    "service": {
      "org": "benyaops",
      "service": "flujo-ApDbSnsSqs15-rimac",
      "build": {
        "esbuild": {
          "bundle": true,
          "minify": false,
          "external": [
            "@aws-sdk/*"
          ],
          "packages": "external"
        }
      },
      "provider": {
        "name": "aws",
        "runtime": "nodejs20.x",
        "region": "us-east-1",
        "iam": {
          "role": {
            "statements": [
              {
                "Effect": "Allow",
                "Action": [
                  "dynamodb:PutItem",
                  "dynamodb:Query"
                ],
                "Resource": [
                  "arn:aws:dynamodb:us-east-1:851725266862:table/RimacTablev2",
                  "arn:aws:dynamodb:us-east-1:851725266862:table/RimacTablev2/index/*"
                ]
              },
              {
                "Effect": "Allow",
                "Action": [
                  "sns:Publish"
                ],
                "Resource": {
                  "Ref": "TopicCentral"
                }
              }
            ]
          }
        }
      },
      "functions": {
        "consultarDynamo": {
          "handler": "handlers/handler.consultarDynamo",
          "events": [
            {
              "httpApi": {
                "path": "/registrar",
                "method": "post"
              }
            },
            {
              "httpApi": {
                "path": "/consultar/{insuredId}",
                "method": "get"
              }
            }
          ],
          "environment": {
            "TOPIC_ARN": {
              "Ref": "TopicCentral"
            },
            "TABLE_NAME": "RimacTablev2"
          }
        },
        "appointment_pe": {
          "handler": "handlers/workers.appointment_pe",
          "events": [
            {
              "sqs": {
                "arn": {
                  "Fn::GetAtt": [
                    "ColaPE",
                    "Arn"
                  ]
                }
              }
            }
          ],
          "environment": {
            "DB_HOST": "ep-spring-hat-ajpgkw66-pooler.c-3.us-east-2.aws.neon.tech",
            "DB_NAME": "neondb",
            "DB_USER": "neondb_owner",
            "DB_PASS": "npg_5MpucoayHAF8"
          }
        },
        "appointment_cl": {
          "handler": "handlers/workers.appointment_cl",
          "events": [
            {
              "sqs": {
                "arn": {
                  "Fn::GetAtt": [
                    "ColaCL",
                    "Arn"
                  ]
                }
              }
            }
          ],
          "environment": {
            "DB_HOST": "ep-spring-hat-ajpgkw66-pooler.c-3.us-east-2.aws.neon.tech",
            "DB_NAME": "neondb",
            "DB_USER": "neondb_owner",
            "DB_PASS": "npg_5MpucoayHAF8"
          }
        }
      },
      "resources": {
        "Resources": {
          "TopicCentral": {
            "Type": "AWS::SNS::Topic"
          },
          "ColaPE": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
              "QueueName": "sqs_pe15"
            }
          },
          "ColaCL": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
              "QueueName": "sqs_cl15"
            }
          },
          "SuscripcionPE": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
              "Protocol": "sqs",
              "TopicArn": {
                "Ref": "TopicCentral"
              },
              "Endpoint": {
                "Fn::GetAtt": [
                  "ColaPE",
                  "Arn"
                ]
              },
              "FilterPolicy": {
                "countryISO": [
                  "pe"
                ]
              }
            }
          },
          "SuscripcionCL": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
              "Protocol": "sqs",
              "TopicArn": {
                "Ref": "TopicCentral"
              },
              "Endpoint": {
                "Fn::GetAtt": [
                  "ColaCL",
                  "Arn"
                ]
              },
              "FilterPolicy": {
                "countryISO": [
                  "cl"
                ]
              }
            }
          },
          "SuscripcionEmail": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
              "Protocol": "email",
              "TopicArn": {
                "Ref": "TopicCentral"
              },
              "Endpoint": "benyaroot@gmail.com"
            }
          },
          "SqsPolicy": {
            "Type": "AWS::SQS::QueuePolicy",
            "Properties": {
              "Queues": [
                {
                  "Ref": "ColaPE"
                },
                {
                  "Ref": "ColaCL"
                }
              ],
              "PolicyDocument": {
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": "*",
                    "Action": "sqs:SendMessage",
                    "Resource": "*",
                    "Condition": {
                      "ArnEquals": {
                        "aws:SourceArn": {
                          "Ref": "TopicCentral"
                        }
                      }
                    }
                  }
                ]
              }
            }
          }
        }
      }
    },
    "provider": {
      "name": "aws",
      "runtime": "nodejs20.x",
      "region": "us-east-1",
      "iam": {
        "role": {
          "statements": [
            {
              "Effect": "Allow",
              "Action": [
                "dynamodb:PutItem",
                "dynamodb:Query"
              ],
              "Resource": [
                "arn:aws:dynamodb:us-east-1:851725266862:table/RimacTablev2",
                "arn:aws:dynamodb:us-east-1:851725266862:table/RimacTablev2/index/*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "sns:Publish"
              ],
              "Resource": {
                "Ref": "TopicCentral"
              }
            }
          ]
        }
      }
    },
    "serviceRawFile": "org: benyaops\nservice: flujo-ApDbSnsSqs15-rimac\n\nbuild:\n  esbuild:\n    bundle: true\n    minify: false\n    external:\n      - '@aws-sdk/*'\n    packages: external # Esto asegura que librerías como 'pg' se incluyan correctamente\n\n\nprovider:\n  name: aws\n  runtime: nodejs20.x\n  region: us-east-1\n  iam:\n    role:\n      statements:\n        # Permisos para DynamoDB\n        - Effect: Allow\n          Action:\n            - dynamodb:PutItem\n            - dynamodb:Query\n          Resource:\n            - arn:aws:dynamodb:us-east-1:851725266862:table/RimacTablev2\n            - arn:aws:dynamodb:us-east-1:851725266862:table/RimacTablev2/index/*\n        # Permisos para SNS\n        - Effect: Allow\n          Action: [\"sns:Publish\"]\n          Resource: !Ref TopicCentral\n\n\n\nfunctions:\n  # 1. El Productor\n  consultarDynamo:\n    handler: handlers/handler.consultarDynamo\n    events:\n      - httpApi:\n          path: /registrar\n          method: post\n      # Ruta para consultar (GET)\n      - httpApi:\n          path: /consultar/{insuredId} # deberia ser insuredId, pero esta vez lo cambiamos a userId para que sea mas generico\n          method: get\n    environment:\n      TOPIC_ARN: !Ref TopicCentral\n      TABLE_NAME: RimacTablev2\n\n  # 2. Los Workers (Consumidores)\n  appointment_pe:\n    handler: handlers/workers.appointment_pe\n    events:\n      - sqs:\n          arn: !GetAtt ColaPE.Arn\n    environment:\n      DB_HOST: \"ep-spring-hat-ajpgkw66-pooler.c-3.us-east-2.aws.neon.tech\"\n      DB_NAME: \"neondb\"\n      DB_USER: \"neondb_owner\"\n      DB_PASS: \"npg_5MpucoayHAF8\"\n\n  appointment_cl:\n    handler: handlers/workers.appointment_cl\n    events:\n      - sqs:\n          arn: !GetAtt ColaCL.Arn\n    environment:\n      DB_HOST: \"ep-spring-hat-ajpgkw66-pooler.c-3.us-east-2.aws.neon.tech\"\n      DB_NAME: \"neondb\"\n      DB_USER: \"neondb_owner\"\n      DB_PASS: \"npg_5MpucoayHAF8\"\n\nresources:\n  Resources:\n    # SNS Topic\n    TopicCentral:\n      Type: AWS::SNS::Topic\n\n    # Colas SQS\n    ColaPE:\n      Type: AWS::SQS::Queue\n      Properties:\n        QueueName: sqs_pe15\n    ColaCL:\n      Type: AWS::SQS::Queue\n      Properties:\n        QueueName: sqs_cl15\n\n    # Suscripciones con Filtros\n    SuscripcionPE:\n      Type: AWS::SNS::Subscription\n      Properties:\n        Protocol: sqs\n        TopicArn: !Ref TopicCentral\n        Endpoint: !GetAtt ColaPE.Arn\n        FilterPolicy:\n          countryISO: [\"pe\"]\n\n    SuscripcionCL:\n      Type: AWS::SNS::Subscription\n      Properties:\n        Protocol: sqs\n        TopicArn: !Ref TopicCentral\n        Endpoint: !GetAtt ColaCL.Arn\n        FilterPolicy:\n          countryISO: [\"cl\"]\n\n    # Suscripción de Email (Sin filtro para recibir todo)\n    SuscripcionEmail:\n      Type: AWS::SNS::Subscription\n      Properties:\n        Protocol: email\n        TopicArn: !Ref TopicCentral\n        Endpoint: \"benyaroot@gmail.com\"\n\n    # Política para que SNS pueda hablar con SQS\n    SqsPolicy:\n      Type: AWS::SQS::QueuePolicy\n      Properties:\n        Queues: [ !Ref ColaPE, !Ref ColaCL ]\n        PolicyDocument:\n          Statement:\n            - Effect: Allow\n              Principal: \"*\"\n              Action: \"sqs:SendMessage\"\n              Resource: \"*\"\n              Condition:\n                ArnEquals:\n                  aws:SourceArn: !Ref TopicCentral\n",
    "command": [],
    "options": {},
    "serviceProviderAwsCfStackId": "arn:aws:cloudformation:us-east-1:851725266862:stack/flujo-ApDbSnsSqs15-rimac-dev/b6fe8290-05ad-11f1-9ef8-0ee344b43e95",
    "serviceProviderAwsCfStackCreated": "2026-02-09T11:51:48.403Z",
    "serviceProviderAwsCfStackUpdated": null,
    "serviceProviderAwsCfStackStatus": "CREATE_COMPLETE",
    "serviceProviderAwsCfStackOutputs": [
      {
        "OutputKey": "AppointmentUnderscoreclLambdaFunctionQualifiedArn",
        "OutputValue": "arn:aws:lambda:us-east-1:851725266862:function:flujo-ApDbSnsSqs15-rimac-dev-appointment_cl:1",
        "Description": "Current Lambda function version",
        "ExportName": "sls-flujo-ApDbSnsSqs15-rimac-dev-AppointmentUnderscoreclLambdaFunctionQualifiedArn"
      },
      {
        "OutputKey": "AppointmentUnderscorepeLambdaFunctionQualifiedArn",
        "OutputValue": "arn:aws:lambda:us-east-1:851725266862:function:flujo-ApDbSnsSqs15-rimac-dev-appointment_pe:1",
        "Description": "Current Lambda function version",
        "ExportName": "sls-flujo-ApDbSnsSqs15-rimac-dev-AppointmentUnderscorepeLambdaFunctionQualifiedArn"
      },
      {
        "OutputKey": "ConsultarDynamoLambdaFunctionQualifiedArn",
        "OutputValue": "arn:aws:lambda:us-east-1:851725266862:function:flujo-ApDbSnsSqs15-rimac-dev-consultarDynamo:1",
        "Description": "Current Lambda function version",
        "ExportName": "sls-flujo-ApDbSnsSqs15-rimac-dev-ConsultarDynamoLambdaFunctionQualifiedArn"
      },
      {
        "OutputKey": "HttpApiId",
        "OutputValue": "m2i02b459j",
        "Description": "Id of the HTTP API",
        "ExportName": "sls-flujo-ApDbSnsSqs15-rimac-dev-HttpApiId"
      },
      {
        "OutputKey": "ServerlessDeploymentBucketName",
        "OutputValue": "serverless-framework-deployments-us-east-1-a596bce8-6931",
        "ExportName": "sls-flujo-ApDbSnsSqs15-rimac-dev-ServerlessDeploymentBucketName"
      },
      {
        "OutputKey": "HttpApiUrl",
        "OutputValue": "https://m2i02b459j.execute-api.us-east-1.amazonaws.com",
        "Description": "URL of the HTTP API",
        "ExportName": "sls-flujo-ApDbSnsSqs15-rimac-dev-HttpApiUrl"
      }
    ]
  }
}